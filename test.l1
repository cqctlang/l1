listref = lambda(l, i){
	if(i == 0)
		return car(l);
	else
		return listref(cdr(l), i-1);
};

dispatch = lambda a {
	arg = listref(a, 0);

	if(arg == "get"){
		range = listref(a, 1);
		print("get ");
		print(rangebeg(range));
		print(" ");
		print(rangelen(range));
		print("\n");
		return;
	}

	if(arg == "looksym"){
		sym = listref(a, 1);
		print("looksym ");
		print(sym);
		print("\n");
		return;
	}

	if(arg == "put"){
		range = listref(a, 1);
		str = listref(a, 2);
		print("put ");
		print(rangebeg(range));
		print(" ");
		print(rangelen(range));
		print(" ");
		print(str);
		print("\n");
	}

	printf("bad argument to dispatch\n");
};

test1 = lambda() {
	x = `sym;
};

test2 = lambda(){
	v = mkvec(5);
	print(v);
	for(i = 0; i < veclen(v); i++)
		vecset(v, i, i*i);
	print(v);
	for(i = 0; i < veclen(v); i++)
		print(vecref(v, i));
};

//test2();

test3 = lambda(){
	v = vector(10,11,12,13,14);
	print(v);
	for(i = 0; i < veclen(v); i++)
		print(vecref(v, i));
	print(v);
	for(i = 0; i < veclen(v); i++)
		vecset(v, i, i*i);
	print(v);
	for(i = 0; i < veclen(v); i++)
		print(vecref(v, i));
};

//test3();

test4 = lambda(){
	v = vector();
	print(v);
	for(i = 0; i < veclen(v); i++)
		print(vecref(v, i));
	print(v);
	for(i = 0; i < veclen(v); i++)
		vecset(v, i, i*i);
	print(v);
	for(i = 0; i < veclen(v); i++)
		print(vecref(v, i));
};

//test4();

test5 = lambda(){
	v = vector();
	print(v);
	vecset(v, 10, 11);
};

//test5();

printvec = lambda(v){
	@local i, n, x;
	n = veclen(v);
	for(i = 0; i < n; i++){
		x = vecref(v, i);
		if(isvector(x))
			printvec(x);
		else if(istypename(x)){
			print(x);
			printvec(typenamex(x));
		}else
			print(x);
	}
};

foreachtab = lambda(tab, fn){
	@local i, v, n;
	v = tabenum(tab);
	n = veclen(v)/2;
	for(i = 0; i < n; i++){
		key = vecref(v, i);
		val = vecref(v, i+n);
		fn(key, val);
	}
};


mknames = lambda(names, tid, tag, sym){
	print("mknames");
	foreachtab(sym, lambda(id,def){
			   print(id);
			   print(vecref(def,0));
			   printvec(typenamex(vecref(def,1)));
		   });
};

test6 = lambda(){
	ns = @names 1 {
		@0x0  int x;
		@0x4  int *y;
		@0x8  long (*func)(int arg1, char *arg2);
		@0xc  struct foo s;
		@0x10 struct foo *sp;
		@0x14 int a1[];
		@0x18 int a2[11];
	};
};

test6();
